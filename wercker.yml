box: hseeberger/scala-sbt
build:
  steps:
    - script:
        name: compile
        code: |
          sbt clean compile test

scaladoc:
  steps:
    - script:
        name: Generate Scaladoc
        code: |
          sbt clean compile doc
    - script:
        name: Move Scaladoc
        code: |
          echo "================="
          export VER=$(sbt 'inspect version' | grep Setting | awk '{print $NF}')
          echo $VER
          echo "================="
          export PROJECT_VERSION=$(date +%s%3)
          mkdir -p /pipeline/source/target/scala-2.11/tmp/
          mv /pipeline/source/target/scala-2.11/api/* /pipeline/source/target/scala-2.11/tmp/
          mkdir -p /pipeline/source/target/scala-2.11/api/docs/${PROJECT_VERSION}/api
          mv /pipeline/source/target/scala-2.11/tmp/* /pipeline/source/target/scala-2.11/api/docs/${PROJECT_VERSION}/api/
          ls -R /pipeline/source/target/scala-2.11/api
    - script:
        name: Configure Git
        code: |-
          # git config --global push.default matching
          git config --global push.default simple
          git config --global user.email "$GITHUB_EMAIL"
          git config --global user.name "$GITHUB_USERNAME"
          # https://help.github.com/articles/error-permission-denied-publickey/#platform-all
          # ssh -vT git@github.com
    - script:
        # https://vaadin.com/blog/-/blogs/host-your-javadoc-s-online-in-github
        name: publish scaladoc
        code: |
          cd /pipeline/source/target/scala-2.11/api/
          echo "AAAAAAAAAAAAA"
          ls /pipeline/source/target/scala-2.11/api/docs
          git init          
          echo "BBBBBBBBBBBB"
          ls /pipeline/source/target/scala-2.11/api/docs
          git remote add javadoc https://$GITHUB_USERNAME:$GITHUB_PASSWORD@github.com/logimethods/nats-connector-gatling.git
          echo "CCCCCCCCCCCCCCCCCC"
          ls /pipeline/source/target/scala-2.11/api/docs
          git fetch --depth=1 javadoc gh-pages
          echo "DDDDDDDDDDDDDD"
          ls /pipeline/source/target/scala-2.11/api/docs
          git add --all        
          echo "EEEEEEEEEEEEEEE"
          ls /pipeline/source/target/scala-2.11/api/docs
          git commit -m "Wercker Build Id: ${WERCKER_BUILD_ID}"
          echo "FFFFFFFFFFFF"
          ls /pipeline/source/target/scala-2.11/api/docs
          git merge --no-edit -s ours remotes/javadoc/gh-pages
          echo "GGGGGGGGGGGGG"
          ls /pipeline/source/target/scala-2.11/api/docs
          git push javadoc master:gh-pages
          echo "HHHHHHHHHHHH"
          ls /pipeline/source/target/scala-2.11/api/docs
          
deploy:
  steps:
    - script:
        name: deploy
        code: |
          echo "${SONATYPE_PGP_SECRING_64}" | base64 -d > /pipeline/source/secring.asc
          echo "${SONATYPE_PGP_PUBRING_64}" | base64 -d > /pipeline/source/pubring.asc
          ### sbt clean compile publishSigned
          # sonatypeRelease

deploy-snapshot:
  steps:
    - script:
        name: deploy-snapshot
        code: |
          sbt clean compile publish
